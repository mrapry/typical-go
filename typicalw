#!/bin/bash
set -e

CHECKSUM_DATA=$(cksum typical/context.go)

if ! [ -s .typical-metadata/checksum ]; then
	mkdir -p .typical-metadata
	cksum typical/context.go > .typical-metadata/checksum
else
	CHECKSUM_UPDATED=$([ "$CHECKSUM_DATA" == "$(cat .typical-metadata/checksum )" ] ; echo $?)
fi

if [ "$CHECKSUM_UPDATED" == "1" ] || ! [[ -f bin/typical-go-prebuilder ]] ; then 
	echo $CHECKSUM_DATA > .typical-metadata/checksum
	echo "Build the prebuilder"
	go build -o bin/typical-go-prebuilder ./cmd/typical-go-prebuilder
fi

./bin/typical-go-prebuilder $CHECKSUM_UPDATED
./bin/typical-go-buildtool $@